<!-- src/app/components/change-password/change-password.component.html -->

<!-- Conditional Navbar based on role -->
<app-admin-navbar *ngIf="isAdmin"></app-admin-navbar>
<app-manager-navbar *ngIf="isManager"></app-manager-navbar>
<app-client-navbar *ngIf="isClient"></app-client-navbar>

<div class="change-password-container" [ngClass]="getThemeClass()">
  
  <!-- Header Section -->
  <div class="header-section">
    <mat-card class="header-card" [ngClass]="getThemeClass()">
      <div class="header-content">
        <div class="header-text">
          <h1>{{ getHeaderTitle() }}</h1>
          <p>{{ getHeaderSubtitle() }}</p>
        </div>
        <div class="user-info" *ngIf="currentUser">
          <div class="user-avatar" [ngClass]="getThemeClass()">
            <mat-icon>person</mat-icon>
          </div>
          <div class="user-details">
            <span class="user-name">{{ getUserFullName() }}</span>
            <span class="user-email">{{ currentUser.email }}</span>
          </div>
        </div>
      </div>
    </mat-card>
  </div>

  <!-- Main Content -->
  <div class="content-section">
    <mat-card class="password-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon class="card-icon" [ngClass]="getThemeClass()">lock</mat-icon>
          Change Your Password
        </mat-card-title>
        <mat-card-subtitle>
          Choose a strong password to keep your account secure
        </mat-card-subtitle>
      </mat-card-header>

      <mat-divider></mat-divider>

      <mat-card-content>
        <form [formGroup]="passwordForm" (ngSubmit)="onSubmit()" novalidate>
          
          <div class="form-section">
            
            <!-- Current Password -->
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Current Password</mat-label>
              <input matInput 
                     [type]="showCurrentPassword ? 'text' : 'password'"
                     formControlName="currentPassword"
                     placeholder="Enter your current password"
                     autocomplete="current-password"
                     required>
              <button mat-icon-button 
                      matSuffix 
                      type="button"
                      (click)="togglePasswordVisibility('current')"
                      [attr.aria-label]="'Toggle password visibility'"
                      [attr.aria-pressed]="showCurrentPassword">
                <mat-icon>{{ showCurrentPassword ? 'visibility_off' : 'visibility' }}</mat-icon>
              </button>
              <mat-error>{{ getFieldError('currentPassword') }}</mat-error>
            </mat-form-field>

            <!-- New Password -->
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>New Password</mat-label>
              <input matInput 
                     [type]="showNewPassword ? 'text' : 'password'"
                     formControlName="newPassword"
                     placeholder="Enter your new password"
                     autocomplete="new-password"
                     maxlength="100"
                     required>
              <button mat-icon-button 
                      matSuffix 
                      type="button"
                      (click)="togglePasswordVisibility('new')"
                      [attr.aria-label]="'Toggle password visibility'"
                      [attr.aria-pressed]="showNewPassword">
                <mat-icon>{{ showNewPassword ? 'visibility_off' : 'visibility' }}</mat-icon>
              </button>
              <mat-hint align="start">
                Minimum 8 characters with uppercase, lowercase, numbers, and special characters
              </mat-hint>
              <mat-hint align="end">{{ getCharacterCount('newPassword') }}/100</mat-hint>
              <mat-error>{{ getFieldError('newPassword') }}</mat-error>
            </mat-form-field>

            <!-- Password Strength Indicator -->
            <div class="password-strength" *ngIf="passwordForm.get('newPassword')?.value">
              <div class="strength-label">Password Strength:</div>
              <div class="strength-bar">
                <div class="strength-fill" 
                     [ngClass]="getPasswordStrengthClass()"
                     [style.width.%]="(getPasswordStrength() / 5) * 100">
                </div>
              </div>
              <div class="strength-text" [ngClass]="getPasswordStrengthClass()">
                {{ getPasswordStrengthText() }}
              </div>
            </div>

            <!-- Confirm Password -->
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Confirm New Password</mat-label>
              <input matInput 
                     [type]="showConfirmPassword ? 'text' : 'password'"
                     formControlName="confirmPassword"
                     placeholder="Confirm your new password"
                     autocomplete="new-password"
                     required>
              <button mat-icon-button 
                      matSuffix 
                      type="button"
                      (click)="togglePasswordVisibility('confirm')"
                      [attr.aria-label]="'Toggle password visibility'"
                      [attr.aria-pressed]="showConfirmPassword">
                <mat-icon>{{ showConfirmPassword ? 'visibility_off' : 'visibility' }}</mat-icon>
              </button>
              <mat-error>{{ getFieldError('confirmPassword') }}</mat-error>
            </mat-form-field>

          </div>

          <!-- Security Notice -->
          <div class="security-notice">
            <mat-icon class="notice-icon">info</mat-icon>
            <div class="notice-content">
              <strong>Security Tips:</strong>
              <ul>
                <li>Use a unique password that you don't use elsewhere</li>
                <li>Include a mix of uppercase, lowercase, numbers, and symbols</li>
                <li>Avoid using personal information in your password</li>
                <li>Consider using a password manager</li>
              </ul>
            </div>
          </div>

        </form>
      </mat-card-content>

      <mat-divider></mat-divider>

      <!-- Actions -->
      <mat-card-actions class="card-actions">
        <button mat-button 
                type="button" 
                (click)="onCancel()"
                [disabled]="isSubmitting"
                class="cancel-btn">
          <mat-icon>arrow_back</mat-icon>
          Cancel
        </button>
        
        <button mat-raised-button 
                color="primary"
                type="submit"
                [disabled]="!passwordForm.valid || isSubmitting"
                (click)="onSubmit()"
                class="submit-btn"
                [ngClass]="getThemeClass()">
          <mat-spinner diameter="20" *ngIf="isSubmitting" class="button-spinner"></mat-spinner>
          <mat-icon *ngIf="!isSubmitting">security</mat-icon>
          {{ isSubmitting ? 'Changing Password...' : 'Change Password' }}
        </button>
      </mat-card-actions>

    </mat-card>
  </div>

</div>